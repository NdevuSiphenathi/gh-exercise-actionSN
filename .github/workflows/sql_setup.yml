name: AutoTest DB Setup via zrok

on:
  push:
    branches: [ main ]

jobs:
  setup-db:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run SQL Automation
        run: |
          $server = "${{ secrets.ZROK_SQL_ENDPOINT }}"
          $password = "${{ secrets.SQL_SERVER_PASSWORD }}"

          $sqlScript = @"
          -- Create database if missing
          IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = 'AutoTest')
          CREATE DATABASE AutoTest;
          GO

          USE AutoTest;
          GO

          -- Create login/user ONLY if missing
          IF NOT EXISTS (SELECT * FROM sys.server_principals WHERE name = 'Auto_user')
          BEGIN
              CREATE LOGIN Auto_user WITH PASSWORD = '$password';
              CREATE USER Auto_user FOR LOGIN Auto_user;
              EXEC sp_addrolemember 'db_owner', 'Auto_user';
          END
          GO

          -- Create table if missing
          IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'user')
          CREATE TABLE [user] (
              Name NVARCHAR(50),
              Surname NVARCHAR(50),
              Email NVARCHAR(100)
          );
          GO

          -- Create/update stored procedure
          CREATE OR ALTER PROCEDURE InsertUserData
              @Name NVARCHAR(50),
              @Surname NVARCHAR(50),
              @Email NVARCHAR(100)
          AS
          BEGIN
              INSERT INTO [user] (Name, Surname, Email)
              VALUES (@Name, @Surname, @Email);
          END;
          GO

          -- Insert test data
          EXEC InsertUserData 'GitHub', 'Action', 'ci@example.com';
          GO
          "@

          sqlcmd -S $server -U Auto_user -P $password -Q "$sqlScript"
